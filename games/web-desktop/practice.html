<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practice Mode</title>
    <style>
        :root{
            --bg:#0d1117;--green:#00ff41;--red:#ff3333;--gray:#161b22;--mono:'Courier New',monospace;
        }
        *{box-sizing:border-box;margin:0;padding:0;}
        body{background:var(--bg);color:var(--green);font-family:var(--mono);height:100vh;display:flex;justify-content:center;align-items:center;overflow:hidden;position:relative;}
        body::after{content:"";position:absolute;inset:0;background:linear-gradient(rgba(18,16,16,0)50%,rgba(0,0,0,.25)50%),linear-gradient(90deg,rgba(255,0,0,.06),rgba(0,255,0,.02),rgba(0,0,255,.06));background-size:100% 2px,3px 100%;pointer-events:none;z-index:2;}
        .container{width:90%;max-width:850px;height:90%;background:var(--gray);border:2px solid var(--green);border-radius:10px;box-shadow:0 0 30px rgba(0,255,65,.3);display:flex;flex-direction:column;position:relative;}
        .hud{padding:15px 25px;border-bottom:1px solid var(--green);display:flex;justify-content:space-between;font-weight:bold;font-size:1.2rem;}
        .timer{color:var(--red);text-shadow:0 0 5px var(--red);}
        .main{flex:1;padding:30px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:30px;}
        .question{background:#000;border:1px solid #333;padding:30px;border-radius:8px;width:100%;text-align:center;}
        .qtitle{font-size:1rem;color:#888;margin-bottom:10px;}
        .qtext{font-size:2.5rem;font-weight:bold;letter-spacing:2px;text-shadow:0 0 10px var(--green);}
        img{max-width:100%;max-height:200px;margin:20px 0;border:1px solid var(--green);border-radius:8px;}
        .options{display:grid;grid-template-columns:1fr 1fr;gap:20px;width:100%;margin-top:20px;}
        .opt-btn{background:#222;border:2px solid #555;color:white;padding:20px;font-size:1.5rem;cursor:pointer;border-radius:8px;transition:.2s;position:relative;}
        .opt-btn::before{content:'';position:absolute;left:10px;top:50%;transform:translateY(-50%);width:15px;height:15px;border-radius:50%;background:currentColor;box-shadow:0 0 10px currentColor;}
        .opt-btn:nth-child(1){color:#ffeb3b;border-color:#ffeb3b;}
        .opt-btn:nth-child(2){color:#00bcd4;border-color:#00bcd4;}
        .opt-btn:nth-child(3){color:#e91e63;border-color:#e91e63;}
        .opt-btn:nth-child(4){color:#ff9800;border-color:#ff9800;}
        .opt-btn:hover{transform:scale(1.05);background:rgba(255,255,255,.1);}
        input[type=text]{width:100%;padding:20px;font-size:1.8rem;text-align:center;background:#000;color:var(--green);border:2px solid var(--green);border-radius:8px;font-family:var(--mono);margin-top:20px;}
        .submit-btn{background:var(--green);color:black;padding:15px 40px;font-size:1.5rem;margin-top:20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
        .feedback{font-size:2rem;margin-top:20px;font-weight:bold;}
        @keyframes shake{0%,100%{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-10px,0)}20%,40%,60%,80%{transform:translate(10px,0)}}
        .shake{animation:shake .5s}
    </style>
</head>
<body>
<div class="container">
    <div class="hud">
        <div id="title">Practice Mode</div>
        <div>SCORE: <span id="score">0000</span></div>
        <div class="timer">TIME: <span id="timer">60.00</span></div>
    </div>
    <div class="main">
        <div class="question">
            <div class="qtitle">DECRYPT THE DATA</div>
            <div class="qtext" id="question-text">Loading...</div>
            <img id="qimg" src="" style="display:none;">
            <div id="input-area" style="display:none;">
                <input type="text" id="fill-input" placeholder="输入答案...">
                <button class="submit-btn" onclick="checkFill()">提交</button>
            </div>
            <div id="options-area" class="options"></div>
            <div class="feedback" id="feedback"></div>
        </div>
    </div>
</div>

<script>
console.log("practice.html 已加载，开始诊断...");

// 1. 读取 URL 参数 key
const urlParams = new URLSearchParams(window.location.search);
const key = urlParams.get('key');
console.log("URL 参数 key =", key);

// 2. 尝试从父页面读取 practiceData
let data = null;
if (window.parent && window.parent.practiceData) {
    console.log("父页面有 practiceData 对象", Object.keys(window.parent.practiceData));
    if (window.parent.practiceData[key]) {
        data = window.parent.practiceData[key];
        console.log("成功从父页面拿到题目数据！", data);
    } else {
        console.log("父页面有 practiceData，但没有这个 key:", key);
    }
} else {
    console.log("父页面没有 practiceData 对象");
}

// 3. 如果父页面没拿到，再试试自己有没有
if (!data && window.practiceData && window.practiceData[key]) {
    data = window.practiceData[key];
    console.log("从当前窗口拿到数据", data);
}

// 4. 最终结果
if (data) {
    console.log("题目加载成功！标题:", data.title, "题目数量:", data.questions.length);
    document.getElementById('title').innerText = data.title || "Practice Mode";
    questions = data.questions;
    startPractice();
} else {
    console.log("最终没有拿到任何数据，显示 No Practice Found");
    document.getElementById('question-text').innerText = "No Practice Found: " + key;
}

let questions = [], current = 0, score = 0, timeLeft = 60, timer;

function startPractice() {
    console.log("startPractice 开始执行");
    score = 0; timeLeft = 60;
    document.getElementById('score').innerText = "0000";
    timer = setInterval(() => {
        timeLeft -= 0.1;
        document.getElementById('timer').innerText = timeLeft.toFixed(2);
        if (timeLeft <= 10) document.querySelector('.timer').style.color = "#ff0000";
        if (timeLeft <= 0) endPractice(false);
    }, 100);
    loadQuestion();
}

function loadQuestion() {
    console.log("loadQuestion 当前题号:", current);
    if (current >= questions.length) { endPractice(true); return; }
    const q = questions[current];
    console.log("当前题目:", q);
    document.getElementById('question-text').innerText = q.q;
    document.getElementById('feedback').innerText = '';
    document.getElementById('input-area').style.display = 'none';
    document.getElementById('options-area').innerHTML = '';
    document.getElementById('qimg').style.display = 'none';
    document.getElementById('qimg').src = '';

    if (q.img) {
        document.getElementById('qimg').src = q.img;
        document.getElementById('qimg').style.display = 'block';
    }

    if (q.type === 'fill') {
        document.getElementById('input-area').style.display = 'block';
        setTimeout(() => document.getElementById('fill-input').focus(), 100);
    } else {
        q.options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => checkChoice(opt);
            document.getElementById('options-area').appendChild(btn);
        });
    }
}

function checkChoice(ans) {
    const correct = questions[current].a;
    if (ans === correct) success(); else fail();
}

function checkFill() {
    const input = document.getElementById('fill-input').value.trim();
    const correct = questions[current].a;
    if (input === correct) success(); else fail();
}

function success() {
    score += 100;
    document.getElementById('score').innerText = score.toString().padStart(4,'0');
    document.getElementById('feedback').style.color = '#00ff41';
    document.getElementById('feedback').innerText = "CORRECT";
    current++;
    setTimeout(loadQuestion, 800);
}

function fail() {
    document.querySelector('.container').classList.add('shake');
    setTimeout(() => document.querySelector('.container').classList.remove('shake'), 500);
    timeLeft -= 5;
    document.getElementById('feedback').style.color = '#ff3333';
    document.getElementById('feedback').innerText = "ERROR";
}

function endPractice(win) {
    clearInterval(timer);
    alert(win ? `练习完成！得分: ${score}` : "时间到！");
}
</script>
</body>
</html>