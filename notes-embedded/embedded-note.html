<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频课程三段式笔记系统 · 神器版</title>
    <style>
        /* ==================== 基础布局与通用样式 ==================== */
        :root {
            --color-primary: #3f51b5;     /* 靛青 */
            --color-secondary: #00bcd4;   /* 青色 */
            --color-success: #4caf50;     /* 绿色 */
            --color-warning: #ffc107;     /* 黄色 */
            --color-danger: #f44336;      /* 红色 */
            --color-text: #333;
            --color-bg-light: #f7f9fc;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--color-text);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--color-bg-light);
        }

        h1 {
            color: var(--color-primary);
            border-bottom: 3px solid var(--color-primary);
            padding-bottom: 10px;
            text-align: center;
        }

        h2 {
            color: var(--color-success);
            margin-top: 30px;
            padding-left: 15px;
            border-left: 4px solid var(--color-success);
            font-weight: 500;
        }

        h3 {
            color: var(--color-text);
            margin-top: 20px;
            font-size: 1.1em;
        }

        .section-box {
            background-color: #ffffff;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .info-card {
            border: 1px solid #e0e0e0;
            padding: 20px;
            border-radius: 8px;
            background-color: #fcfcfc;
            margin-bottom: 20px;
        }

        .tip {
            font-style: italic;
            color: #78909c;
            margin-top: 10px;
        }

        /* ==================== 标签页样式 ==================== */
        .tabs {
            display: flex;
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            background: #ffffff;
            border: 1px solid #e0e0e0;
        }
        .tab {
            flex: 1;
            padding: 16px 24px;
            background: #f8f8f8;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #666;
            text-align: center;
            white-space: nowrap;
            cursor: pointer;
        }
        .tab:hover {background: #eee;}
        .tab.active {
            background: #ffffff;
            border-bottom: 3px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: bold;
        }

        .section {display: none;}
        .section.active {display: block;}

        /* ==================== 按钮与输入框美化 ==================== */
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            background-color: var(--color-primary);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover {
            background-color: #303f9f;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button[onclick*="delete"] {background-color: var(--color-danger);}
        button[onclick*="delete"]:hover {background-color: #d32f2f;}

        input[type="text"], input[type="date"], textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 5px 0 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus {
            border-color: var(--color-primary);
            outline: none;
        }
        textarea {resize: vertical; min-height: 80px;}

        /* ==================== 实时分层记录样式 ==================== */
        #liveTree {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            line-height: 1.8;
            border: 1px solid #eee;
            min-height: 200px;
        }
        .tree-node {
            position: relative;
            margin: 8px 0;
            padding-left: 30px;
            border-left: 2px solid #e0e0e0;
            transition: background-color 0.1s;
        }
        .tree-node::before {
            content: "•";
            position: absolute;
            left: -5px;
            top: 5px;
            font-size: 20px;
            color: var(--color-primary);
        }
        .selected {
            background-color: #fffde7;
            border-radius: 8px;
            padding: 4px 8px;
        }
        .node-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .node-text {
            flex: 1;
            outline: none;
            padding: 6px 12px;
            border-radius: 8px;
            transition: 0.2s;
            border: 1px dashed transparent;
            min-height: 24px;
        }
        .node-text:focus {
            background: #e3f2fd;
            border-color: var(--color-primary);
        }
        .node-text:empty::before {
            content: attr(placeholder);
            color: #aaa;
        }
        .draw-btn {
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            padding: 4px 8px;
            border-radius: 4px;
            background: #e9ecef;
        }
        .draw-btn:hover {
            opacity: 1;
            background: var(--color-primary);
            color: white;
        }

        /* ==================== 涂鸦区样式 ==================== */
        .draw-zone {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-top: 20px;
        }
        .draw-gallery {
            overflow-y: auto;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: #f9f9f9;
        }
        .thumb {
            cursor: pointer;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: 0.3s;
            width: 100%;
        }
        .thumb:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .thumb-name {
            font-size: 12px;
            text-align: center;
            margin-top: 4px;
            color: #666;
        }
        canvas {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            background: white;
            display: block;
        }

        /* ==================== 闪卡样式 ==================== */
        .flashcards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            position: relative;
            height: 180px;
            perspective: 1000px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            box-sizing: center;
            box-sizing: border-box;
        }
        .card-front {
            background: #f8f9fa;
            font-weight: bold;
            font-size: 18px;
        }
        .card-back {
            background: var(--color-primary);
            color: white;
            transform: rotateY(180deg);
            font-size: 14px;
            overflow: auto;
            text-align: left;
        }

        /* ==================== 思维导图样式 ==================== */
        #mindmap {
            padding: 20px;
            min-height: 600px;
            background: #fafafa;
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid #e0e0e0;
        }
        .node {
            display: inline-block;
            background: white;
            border-radius: 12px;
            padding: 12px 20px;
            margin: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            min-width: 120px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .node:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .node.level-0 { background: var(--color-primary); color: white; font-size: 20px; font-weight: bold; }
        .node.level-1 { background: var(--color-secondary); color: white; }
        .node.level-2 { background: var(--color-success); color: white; }
        .node.level-3 { background: var(--color-warning); color: #333; }
        .node.level-4 { background: #9c27b0; color: white; }
        .node.level-5 { background: #795548; color: white; }
        .children {
            margin-left: 60px;
            margin-top: 10px;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            font-size: 24px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>视频课程三段式笔记系统 · 神器版</h1>

    <div class="tabs">
        <div class="tab active" data-tab="tab1">1. 前置准备</div>
        <div class="tab" data-tab="tab2">2. 实时分层记录</div>
        <div class="tab" data-tab="tab3">3. 涂鸦与关联</div>
        <div class="tab" data-tab="tab4">4. 3D闪卡</div>
        <div class="tab" data-tab="tab5">5. 思维导图</div>
    </div>

    <div id="tab1" class="section active">
        <div class="section-box">
            <h2>1. 前置准备 (Pre-Class)</h2>
            <p class="tip">在观看视频之前，明确目标和关注点。</p>

            <h3>课程信息卡</h3>
            <div class="info-card">
                <ul>
                    <li><strong>课程名称/主题:</strong> <input type="text" id="courseName" placeholder="在此输入课程主题"></li>
                    <li><strong>讲师:</strong> <input type="text" placeholder="讲师姓名"></li>
                    <li><strong>日期:</strong> <input type="date" value="2025-12-01"></li>
                    <li><strong>本集核心目标:</strong> <textarea placeholder="学完希望掌握什么"></textarea></li>
                </ul>
            </div>

            <h3>预习/提纲区</h3>
            <div class="info-card">
                <p><strong>3-5 个核心问题或关键词:</strong></p>
                <ol>
                    <li><input type="text" placeholder="问题/关键词 1"></li>
                    <li><input type="text" placeholder="问题/关键词 2"></li>
                    <li><input type="text" placeholder="问题/关键词 3"></li>
                    <li><input type="text" placeholder="问题/关键词 4"></li>
                    <li><input type="text" placeholder="问题/关键词 5"></li>
                </ol>
            </div>
        </div>
    </div>

    <div id="tab2" class="section">
        <div class="section-box">
            <h2>2. 实时分层记录 (During Class)</h2>
            <p class="tip">使用 Tab 键快速缩进，Enter 键快速添加子节点。</p>
            <div style="margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap;">
                <button onclick="addTopLevel()">+ 核心主题</button>
                <button onclick="addChildToSelected()">+ 子节点</button>
                <button onclick="indentNode()">→ 降一级</button>
                <button onclick="outdentNode()">← 升一级</button>
                <button onclick="deleteNode()">删除</button>
                <button onclick="speechToText()">语音速记</button>
            </div>
            <div id="liveTree">
                <div class="tree-node" data-level="0" data-id="root">
                    <div class="node-content">
                        <span class="node-text" contenteditable placeholder="点击输入本集笔记的核心标题"></span>
                        <span class="draw-btn" title="关联涂鸦" onclick="linkDrawingToNode(this)">Photo</span>
                    </div>
                </div>
            </div>
            <h3>视觉辅助区</h3>
            <ul>
                <li><strong>符号系统:</strong> 重点, 例子, 思考</li>
            </ul>
        </div>
    </div>

    <div id="tab3" class="section">
        <div class="section-box">
            <h2>3. 涂鸦与节点关联</h2>
            <p class="tip">画图后保存，关联到笔记节点，复习时点击图片可跳转。</p>
            <div style="text-align:center;margin:15px 0;">
                <button onclick="clearCanvas()">清屏</button>
                <button onclick="undoLastStroke()">撤销</button>
                <input type="color" id="colorPicker" value="#000000" title="颜色">
                <input type="range" id="brushSize" min="1" max="30" value="5" title="粗细">
                <input type="text" id="drawingName" placeholder="涂鸦名称（如：需求曲线图）" style="width:250px;">
                <button onclick="saveCurrentDrawing()">保存涂鸦</button>
            </div>
            <div class="draw-zone">
                <canvas id="canvas" width="800" height="600"></canvas>
                <div class="draw-gallery">
                    <h3>我的涂鸦库（点击关联到选中节点）</h3>
                    <div id="gallery"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab4" class="section">
        <div class="section-box">
            <h2>4. 课后闪卡复习</h2>
            <p class="tip">自动将父子节点转换为正面(概念)和反面(细节)的卡片。</p>
            <button onclick="generateFlashcards()" style="padding:12px 30px;font-size:18px;">生成闪卡</button>
            <div class="flashcards" id="flashcards"></div>
        </div>
    </div>

    <div id="tab5" class="section">
        <div class="section-box">
            <h2>5. 自动思维导图</h2>
            <p class="tip">根据分层记录的结构，一键生成可视化导图。</p>
            <button onclick="generateMindmap()" style="padding:12px 30px;font-size:18px;">一键生成</button>
            <div id="mindmap"></div>
        </div>
    </div>

    <button class="fab" onclick="saveAll()" title="保存全部笔记">Save</button>

    <script>
        // ==================== 接收章节参数 + 每章独立存储 ====================
        const urlParams = new URLSearchParams(window.location.search);
        const chapterId = urlParams.get('chapter') || 'default';
        const STORAGE_KEY = `videoNoteGod_${chapterId}`;     // 每个章节独立
        const DRAWING_KEY = `drawings_${chapterId}`;         // 涂鸦也独立

        // 自动设置标题
        document.title = `笔记神器 - ${chapterId.replace('_', '.')}`;
        document.querySelector('h1').textContent = `视频课程三段式笔记系统 · ${chapterId.replace('_', '.')}`;
        document.getElementById('courseName').value = `A-Level CS ${chapterId.replace('_', '.')}`;

        // ==================== 标签页切换 ====================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab, .section').forEach(el => el.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            };
        });

        // ==================== 实时分层核心逻辑 ====================
        let selectedNode = null;

        document.addEventListener('click', e => {
            if (e.target.classList.contains('node-text') || e.target.closest('.tree-node')) {
                document.querySelectorAll('.selected').forEach(n => n.classList.remove('selected'));
                const node = e.target.closest('.tree-node');
                node.classList.add('selected');
                selectedNode = node;
            } else if (!e.target.closest('#liveTree')) {
                document.querySelectorAll('.selected').forEach(n => n.classList.remove('selected'));
                selectedNode = null;
            }
        });

        document.addEventListener('keydown', e => {
            if (!selectedNode) return;
            if (e.key === 'Tab') {
                e.preventDefault();
                e.shiftKey ? outdentNode() : indentNode();
            }
            if (e.key === 'Enter' && document.activeElement.hasAttribute('contenteditable')) {
                e.preventDefault();
                addChildToSelected();
            }
        });

        function addTopLevel() {
            const id = 'n' + Date.now();
            const div = document.createElement('div');
            div.className = 'tree-node';
            div.dataset.level = '0';
            div.dataset.id = id;
            div.innerHTML = `
                <div class="node-content">
                    <span class="node-text" contenteditable placeholder="新核心主题"></span>
                    <span class="draw-btn" title="关联涂鸦" onclick="linkDrawingToNode(this)">Photo</span>
                </div>
            `;
            document.getElementById('liveTree').appendChild(div);
            div.querySelector('.node-text').focus();
        }

        function addChildToSelected() {
            if (!selectedNode) return alert('请先选中一行');
            const level = parseInt(selectedNode.dataset.level) + 1;
            const div = document.createElement('div');
            div.className = 'tree-node';
            div.dataset.level = level;
            div.innerHTML = `
                <div class="node-content">
                    <span class="node-text" contenteditable placeholder="子内容"></span>
                    <span class="draw-btn" title="关联涂鸦" onclick="linkDrawingToNode(this)">Photo</span>
                </div>
            `;
            
            let childrenContainer = selectedNode.querySelector('.children');
            if (!childrenContainer) {
                childrenContainer = document.createElement('div');
                childrenContainer.className = 'children';
                selectedNode.appendChild(childrenContainer);
            }
            childrenContainer.appendChild(div);

            div.querySelector('.node-text').focus();
            document.querySelectorAll('.selected').forEach(n => n.classList.remove('selected'));
            div.classList.add('selected');
            selectedNode = div;
        }

        function indentNode() {
            if (!selectedNode || !selectedNode.previousElementSibling) return;
            const prev = selectedNode.previousElementSibling;
            selectedNode.dataset.level = (parseInt(selectedNode.dataset.level) + 1).toString();

            let childrenContainer = prev.querySelector('.children');
            if (!childrenContainer) {
                childrenContainer = document.createElement('div');
                childrenContainer.className = 'children';
                prev.appendChild(childrenContainer);
            }
            childrenContainer.appendChild(selectedNode);
        }

        function outdentNode() {
            if (!selectedNode) return;
            const parentChildren = selectedNode.parentElement;
            if (!parentChildren || !parentChildren.classList.contains('children')) return;

            const grandParentNode = parentChildren.parentElement;
            if (grandParentNode.classList.contains('tree-node')) {
                grandParentNode.insertAdjacentElement('afterend', selectedNode);
                selectedNode.dataset.level = (parseInt(selectedNode.dataset.level) - 1).toString();
            }
        }

        function deleteNode() {
            if (selectedNode && confirm('删除此节点及其所有子节点？')) {
                selectedNode.remove();
                selectedNode = null;
            }
        }

        function speechToText() {
            if (!selectedNode) return alert('请先选中一行');
            if (!('webkitSpeechRecognition' in window)) return alert('浏览器不支持语音');
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.onresult = e => {
                selectedNode.querySelector('.node-text').innerText += e.results[0][0].transcript;
            };
            recognition.start();
        }

        function linkDrawingToNode(btn) {
            if (btn) {
                document.querySelectorAll('.selected').forEach(n => n.classList.remove('selected'));
                const node = btn.closest('.tree-node');
                node.classList.add('selected');
                selectedNode = node;
            }

            if (!selectedNode) return alert('请先选中一行');
            const drawings = JSON.parse(localStorage.getItem(DRAWING_KEY) || '[]');
            if (drawings.length === 0) return alert('先去第3页画张图保存吧！');
            const names = drawings.map((d, i) => `${i+1}. ${d.name}`).join('\n');
            const choice = prompt('选择涂鸦（输入编号）:\n' + names);
            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < drawings.length) {
                insertDrawingToNode(selectedNode, drawings[idx].data, drawings[idx].name);
            }
        }

        function insertDrawingToNode(node, src, name) {
            let img = node.querySelector('img.drawing-img');
            if (img) img.remove();
            img = document.createElement('img');
            img.src = src;
            img.className = 'drawing-img';
            img.style.maxWidth = 'calc(100% - 30px)';
            img.style.borderRadius = '8px';
            img.style.margin = '10px 0';
            img.title = name;
            node.insertBefore(img, node.querySelector('.children') || null);
        }

        // ==================== 涂鸦板逻辑 ====================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let strokes = [];
        let drawing = false;

        canvas.addEventListener('pointerdown', e => {
            drawing = true;
            strokes.push([{x: e.offsetX, y: e.offsetY}]);
        });
        canvas.addEventListener('pointermove', e => {
            if (!drawing) return;
            const stroke = strokes[strokes.length - 1];
            ctx.lineWidth = document.getElementById('brushSize').value;
            ctx.strokeStyle = document.getElementById('colorPicker').value;
            ctx.lineCap = 'round';

            if (stroke.length > 0) {
                ctx.beginPath();
                ctx.moveTo(stroke[stroke.length - 1].x, stroke[stroke.length - 1].y);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
            }
            stroke.push({x: e.offsetX, y: e.offsetY});
        });
        canvas.addEventListener('pointerup', () => drawing = false);
        canvas.addEventListener('pointerleave', () => drawing = false);

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            strokes = [];
        }

        function undoLastStroke() {
            if (strokes.length > 0) {
                strokes.pop();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                strokes.forEach(stroke => {
                    if (stroke.length > 1) {
                        ctx.beginPath();
                        ctx.lineWidth = document.getElementById('brushSize').value;
                        ctx.strokeStyle = document.getElementById('colorPicker').value;
                        ctx.lineCap = 'round';
                        ctx.moveTo(stroke[0].x, stroke[0].y);
                        for(let i = 1; i < stroke.length; i++) {
                            ctx.lineTo(stroke[i].x, stroke[i].y);
                        }
                        ctx.stroke();
                    }
                });
            }
        }

        function saveCurrentDrawing() {
            const name = document.getElementById('drawingName').value.trim() || `涂鸦 ${new Date().toLocaleTimeString()}`;
            const dataURL = canvas.toDataURL();
            let drawings = JSON.parse(localStorage.getItem(DRAWING_KEY) || '[]');
            drawings.push({name, data: dataURL, time: new Date().toLocaleString()});
            localStorage.setItem(DRAWING_KEY, JSON.stringify(drawings));
            alert(`已保存: ${name}`);
            loadGallery();
            document.getElementById('drawingName').value = '';
        }

        function loadGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            const drawings = JSON.parse(localStorage.getItem(DRAWING_KEY) || '[]');
            drawings.forEach((d, i) => {
                const div = document.createElement('div');
                const img = document.createElement('img');
                img.src = d.data;
                img.className = 'thumb';
                img.onclick = () => {
                    if (selectedNode) {
                        insertDrawingToNode(selectedNode, d.data, d.name);
                    } else {
                        alert('请在第2页选中节点');
                    }
                };
                div.appendChild(img);
                const nameSpan = document.createElement('div');
                nameSpan.className = 'thumb-name';
                nameSpan.textContent = d.name;
                div.appendChild(nameSpan);
                gallery.appendChild(div);
            });
        }

        // ==================== 闪卡生成 ====================
        function generateFlashcards() {
            const container = document.getElementById('flashcards');
            container.innerHTML = '';
            let cardsGenerated = 0;

            document.querySelectorAll('#liveTree .tree-node').forEach(node => {
                const nodeTextElement = node.querySelector('.node-text');
                const frontText = nodeTextElement ? nodeTextElement.innerText.trim() : '';
                
                if (frontText) {
                    let backText = '';
                    const childrenContainer = node.querySelector('.children');
                    
                    if (childrenContainer) {
                        Array.from(childrenContainer.querySelectorAll(':scope > .tree-node')).forEach(childNode => {
                            const childTextElement = childNode.querySelector('.node-text');
                            const childText = childTextElement ? childTextElement.innerText.trim() : '';
                            if (childText) {
                                backText += `• ${childText}<br>`;
                            }
                        });
                        backText = backText.trim();
                    }

                    if (!backText) {
                        backText = frontText + '<br><br><span style="opacity: 0.8;">（该节点无子细节，请思考或补充定义）</span>';
                    }

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-front">${frontText}</div>
                            <div class="card-back">${backText}</div>
                        </div>
                    `;
                    card.onclick = () => card.classList.toggle('flipped');
                    container.appendChild(card);
                    cardsGenerated++;
                }
            });

            if (cardsGenerated === 0) {
                container.innerHTML = '<p class="tip" style="text-align: center; color: var(--color-danger); font-weight: bold;">未检测到有效笔记内容。请在“实时分层记录”中输入内容。</p>';
            }
        }

        // ==================== 思维导图生成 ====================
        function parseLiveTreeNode(sourceNode, targetParentContainer, level) {
            const text = sourceNode.querySelector('.node-text').innerText.trim();
            const drawingImg = sourceNode.querySelector('.drawing-img');
            
            if (!text && !drawingImg) return; 

            const targetNode = document.createElement('div');
            targetNode.className = `node level-${Math.min(level, 5)}`;
            
            let content = text;
            if (drawingImg) {
                content += `<br><span style="font-size: 0.8em; opacity: 0.8;"><a href="${drawingImg.src}" target="_blank" style="color: inherit;">[图: ${drawingImg.title || '涂鸦'}]</a></span>`;
            }

            targetNode.innerHTML = `<div contenteditable>${content}</div><div class="children"></div>`;
            targetParentContainer.appendChild(targetNode);

            const sourceChildrenContainer = sourceNode.querySelector('.children');
            if (sourceChildrenContainer) {
                const targetChildrenContainer = targetNode.querySelector('.children');
                sourceChildrenContainer.querySelectorAll(':scope > .tree-node').forEach(childNode => {
                    parseLiveTreeNode(childNode, targetChildrenContainer, level + 1);
                });
            }
        }
        
        function generateMindmap() {
            const container = document.getElementById('mindmap');
            container.innerHTML = '';
            const courseTitle = document.getElementById('courseName').value.trim() || '课程主题';
            const mindmapRoot = document.createElement('div');
            mindmapRoot.className = 'node level-0';
            mindmapRoot.innerHTML = `<div contenteditable>${courseTitle}</div><div class="children"></div>`;
            container.appendChild(mindmapRoot);
            
            const mindmapRootChildren = mindmapRoot.querySelector('.children');
            
            document.querySelectorAll('#liveTree > .tree-node').forEach(sourceNode => {
                 parseLiveTreeNode(sourceNode, mindmapRootChildren, 1);
            });

            if (mindmapRootChildren.children.length === 0) {
                 container.innerHTML = '<p class="tip" style="text-align: center;">请在“实时分层记录”中输入内容并创建层级。</p>';
            }
        }

        // ==================== 自动保存/恢复（按章节独立） ====================
        function saveAll() {
            const data = {
                info: Array.from(document.querySelectorAll('#tab1 input, #tab1 textarea')).map(el => el.value), 
                tree: document.getElementById('liveTree').innerHTML
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved && confirm(`检测到【${chapterId.replace('_', '.')}】的笔记，是否加载？`)) {
                const data = JSON.parse(saved);
                document.querySelectorAll('#tab1 input, #tab1 textarea').forEach((el, i) => el.value = data.info[i] || '');
                document.getElementById('liveTree').innerHTML = data.tree;
            }
            loadGallery();
            setInterval(saveAll, 30000); // 30秒自动保存
        };

        window.onbeforeunload = saveAll;
    </script>
</body>
</html>